<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>화면 공유 - Broadcaster</title>
</head>
<body>
    <h2>📡 Broadcaster (화면 공유)</h2>
    <video id="preview" autoplay playsinline muted style="width: 100%; height: auto; background-color: black;"></video>
    <button id="start">화면 공유 시작</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        const socket = io("https://gocham.zapto.org");
        const video = document.getElementById("preview");
        let peerConnection;
        let screenStream;
        let viewerId = null;

        // ✅ 서버에서 ICE 서버 목록 가져오기
        async function getIceServers() {
            try {
                const response = await fetch("/iceservers");
                const data = await response.json();
                return data.iceServers;
            } catch (error) {
                console.error("❌ ICE 서버 가져오기 실패:", error);
                return [{ urls: "stun:stun.l.google.com:19302" }]; // 기본 STUN 서버
            }
        }

        document.getElementById("start").onclick = async () => {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });

                if (!screenStream) {
                    console.error("❌ 화면 공유 스트림을 가져오지 못했습니다.");
                    return;
                }

                video.srcObject = screenStream;
                socket.emit("broadcaster-ready");

                const iceServers = await getIceServers(); // 서버에서 ICE 서버 정보 가져오기
                peerConnection = new RTCPeerConnection({ iceServers });

                screenStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, screenStream);
                });

                peerConnection.onicecandidate = (event) => {
                    console.log("📡 ICE Candidate 발생:", event.candidate);
                    if (event.candidate && viewerId) {
                        socket.emit("candidate", viewerId, event.candidate);
                    }
                };

                socket.on("viewer-available", async (theViewerId) => {
                console.log(`📡 Viewer 연결됨: ${theViewerId}`);
                viewerId = theViewerId;

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer); // ✅ 먼저 Local Description 설정
                socket.emit("offer", viewerId, offer);
            });


                socket.on("answer", async (fromId, answer) => {
                    console.log("📡 Viewer로부터 Answer 수신:", answer);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                });

                socket.on("candidate", (fromId, candidate) => {
                    console.log("📡 Viewer로부터 ICE Candidate 수신:", candidate);
                    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                });

                peerConnection.onconnectionstatechange = () => {
                    console.log("📡 WebRTC 연결 상태 변경:", peerConnection.connectionState);
                };

            } catch (err) {
                console.error("❌ 화면 공유 오류:", err);
            }
        };
    </script>    
</body>
</html>
