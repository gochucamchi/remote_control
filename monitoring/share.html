<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í™”ë©´ ê³µìœ  - Broadcaster</title>
</head>
<body>
    <h2>ğŸ“¡ Broadcaster (í™”ë©´ ê³µìœ )</h2>
    <video id="preview" autoplay playsinline muted style="width: 100%; height: auto; background-color: black;"></video>
    <button id="start">í™”ë©´ ê³µìœ  ì‹œì‘</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        const socket = io("https://gocham.zapto.org");
        const video = document.getElementById("preview");
        let peerConnection;
        let screenStream;
        let viewerId = null;

        // âœ… ì„œë²„ì—ì„œ ICE ì„œë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getIceServers() {
            try {
                const response = await fetch("/iceservers");
                const data = await response.json();
                return data.iceServers;
            } catch (error) {
                console.error("âŒ ICE ì„œë²„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                return [{ urls: "stun:stun.l.google.com:19302" }]; // ê¸°ë³¸ STUN ì„œë²„
            }
        }

        document.getElementById("start").onclick = async () => {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });

                if (!screenStream) {
                    console.error("âŒ í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    return;
                }

                video.srcObject = screenStream;
                socket.emit("broadcaster-ready");

                const iceServers = await getIceServers(); // ì„œë²„ì—ì„œ ICE ì„œë²„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                peerConnection = new RTCPeerConnection({ iceServers });

                screenStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, screenStream);
                });

                peerConnection.onicecandidate = (event) => {
                    console.log("ğŸ“¡ ICE Candidate ë°œìƒ:", event.candidate);
                    if (event.candidate && viewerId) {
                        socket.emit("candidate", viewerId, event.candidate);
                    }
                };

                socket.on("viewer-available", async (theViewerId) => {
                console.log(`ğŸ“¡ Viewer ì—°ê²°ë¨: ${theViewerId}`);
                viewerId = theViewerId;

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer); // âœ… ë¨¼ì € Local Description ì„¤ì •
                socket.emit("offer", viewerId, offer);
            });


                socket.on("answer", async (fromId, answer) => {
                    console.log("ğŸ“¡ Viewerë¡œë¶€í„° Answer ìˆ˜ì‹ :", answer);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                });

                socket.on("candidate", (fromId, candidate) => {
                    console.log("ğŸ“¡ Viewerë¡œë¶€í„° ICE Candidate ìˆ˜ì‹ :", candidate);
                    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                });

                peerConnection.onconnectionstatechange = () => {
                    console.log("ğŸ“¡ WebRTC ì—°ê²° ìƒíƒœ ë³€ê²½:", peerConnection.connectionState);
                };

            } catch (err) {
                console.error("âŒ í™”ë©´ ê³µìœ  ì˜¤ë¥˜:", err);
            }
        };
    </script>    
</body>
</html>
